(this.webpackJsonp=this.webpackJsonp||[]).push([[16],{93:function(e,t,i){"use strict";function n(e,t){var i=t.x,n=t.y,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=document.createElement("button");return r.concat(["js-image-badge"]).forEach(function(e){return a.classList.add(e)}),a.setAttribute("type","button"),a.setAttribute("disabled",!0),a.dataset.noteId=e,a.style.left=i+"px",a.style.top=n+"px",a}function r(e,t){var i=t.x,n=t.y,r=document.createElement("button");r.classList.add("btn-transparent"),r.classList.add("comment-indicator"),r.setAttribute("type","button"),r.style.left=i+"px",r.style.top=n+"px",r.innerHTML=gl.utils.spriteIcon("image-comment-dark"),e.appendChild(r)}var a={x:0,y:0,width:0,height:0},o=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=t.noteId,n=t.discussionId;this.actual=t.actual||a,this.browser=t.browser||a,this.noteId=i,this.discussionId=n,t.imageEl&&!t.browser&&(this.browser=b.resizeCoordinatesToImageElement(t.imageEl,this.actual))},s=i(0),c=i.n(s);var u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var d=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.el=t,this.canCreateNote=!(!i||!i.canCreateNote),this.renderCommentBadge=!(!i||!i.renderCommentBadge),this.$noteContainer=c()(".note-container",this.el),this.imageBadges=[]}return u(e,[{key:"init",value:function(){this.imageFrameEl=this.el.querySelector(".diff-file .js-image-frame"),this.imageEl=this.imageFrameEl.querySelector("img"),this.bindEvents()}},{key:"bindEvents",value:function(){var e;this.imageClickedWrapper=this.imageClicked.bind(this),this.imageBlurredWrapper=b.removeCommentIndicator.bind(null,this.imageFrameEl),this.addBadgeWrapper=this.addBadge.bind(this),this.removeBadgeWrapper=this.removeBadge.bind(this),this.renderBadgesWrapper=this.renderBadges.bind(this),(e=this.imageEl).complete&&0!==e.naturalHeight?this.renderBadges():this.imageEl.addEventListener("load",this.renderBadgesWrapper),this.$noteContainer.on("click",".js-diff-notes-toggle",b.toggleCollapsed),c()(this.el).on("click",".comment-indicator",b.commentIndicatorOnClick),this.canCreateNote&&(this.el.addEventListener("click.imageDiff",this.imageClickedWrapper),this.el.addEventListener("blur.imageDiff",this.imageBlurredWrapper),this.el.addEventListener("addBadge.imageDiff",this.addBadgeWrapper),this.el.addEventListener("removeBadge.imageDiff",this.removeBadgeWrapper))}},{key:"imageClicked",value:function(e){var t=e.detail,i=b.getTargetSelection(t),n=t.currentTarget;b.setPositionDataAttribute(n,i.actual),b.showCommentIndicator(this.imageFrameEl,i.browser)}},{key:"renderBadges",value:function(){var e=this.el.querySelectorAll(".note-container .discussion-notes .notes");[].concat(function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}(e)).forEach(this.renderBadge.bind(this))}},{key:"renderBadge",value:function(e,t){var i=b.generateBadgeFromDiscussionDOM(this.imageFrameEl,e);this.imageBadges.push(i);var n={coordinate:i.browser,noteId:i.noteId};if(this.renderCommentBadge)b.addImageCommentBadge(this.imageFrameEl,n);else{var r=Object.assign({},n,{badgeText:t+1});b.addImageBadge(this.imageFrameEl,r)}}},{key:"addBadge",value:function(e){var t=e.detail,i=t.x,n=t.y,r=t.width,a=t.height,s=t.noteId,c=t.discussionId,u=this.imageBadges.length+1,d=new o({actual:{x:i,y:n,width:r,height:a},imageEl:this.imageFrameEl.querySelector("img"),noteId:s,discussionId:c});this.imageBadges.push(d),b.addImageBadge(this.imageFrameEl,{coordinate:d.browser,badgeText:u,noteId:s}),b.addAvatarBadge(this.el,{detail:{noteId:s,badgeNumber:u}});var l=this.el.querySelector("#discussion_"+c);b.updateDiscussionBadgeNumber(l,u)}},{key:"removeBadge",value:function(e){var t=this,i=e.detail.badgeNumber,n=i-1,r=this.imageFrameEl.querySelectorAll(".badge");this.imageBadges.length!==i&&this.imageBadges.forEach(function(e,i){if(i>n){var a=e.discussionId,o=i,s=t.el.querySelector("#discussion_"+a);r[i].innerText=o,b.updateDiscussionBadgeNumber(s,o),b.updateDiscussionAvatarBadgeNumber(s,o)}}),this.imageBadges.splice(n,1),r[n].remove()}}]),e}(),l={TWO_UP:"TWO_UP",SWIPE:"SWIPE",ONION_SKIN:"ONION_SKIN"};var h=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function g(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var m=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,d),h(t,[{key:"init",value:function(){var e,t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.TWO_UP;this.imageFrameEls=(g(e={},l.TWO_UP,this.el.querySelector(".two-up .js-image-frame")),g(e,l.SWIPE,this.el.querySelector(".swipe .js-image-frame")),g(e,l.ONION_SKIN,this.el.querySelector(".onion-skin .js-image-frame")),e);var n=this.el.querySelector(".view-modes-menu");this.viewModesEls=(g(t={},l.TWO_UP,n.querySelector(".two-up")),g(t,l.SWIPE,n.querySelector(".swipe")),g(t,l.ONION_SKIN,n.querySelector(".onion-skin")),t),this.currentView=i,this.generateImageEls(),this.bindEvents()}},{key:"generateImageEls",value:function(){var e=this;this.imageEls={},Object.getOwnPropertyNames(l).forEach(function(t){e.imageEls[t]=e.imageFrameEls[t].querySelector("img")})}},{key:"bindEvents",value:function(){(function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0})(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"bindEvents",this).call(this),this.changeToViewTwoUp=this.changeView.bind(this,l.TWO_UP),this.changeToViewSwipe=this.changeView.bind(this,l.SWIPE),this.changeToViewOnionSkin=this.changeView.bind(this,l.ONION_SKIN),this.viewModesEls[l.TWO_UP].addEventListener("click",this.changeToViewTwoUp),this.viewModesEls[l.SWIPE].addEventListener("click",this.changeToViewSwipe),this.viewModesEls[l.ONION_SKIN].addEventListener("click",this.changeToViewOnionSkin)}},{key:"changeView",value:function(e){if(t=e,Object.getOwnPropertyNames(l).find(function(e){return e===t})){var t,i=b.removeCommentIndicator(this.imageFrameEl);this.currentView=e;var n=this.imageFrameEl.querySelectorAll(".badge");[].concat(function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}(n)).map(function(e){return e.remove()}),this.imageBadges=[],setTimeout(this.renderNewView.bind(this,i),250)}}},{key:"renderNewView",value:function(e){if(this.renderBadges(),e.removed){var t=b.resizeCoordinatesToImageElement(this.imageEl,{x:e.x,y:e.y,width:e.image.width,height:e.image.height});b.showCommentIndicator(this.imageFrameEl,t)}}},{key:"imageEl",get:function(){return this.imageEls[this.currentView]}},{key:"imageFrameEl",get:function(){return this.imageFrameEls[this.currentView]}}]),t}(),f=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],n=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw a}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),p=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var v=900,w=["two-up","swipe"],y=function(){function e(t){var i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.views={"two-up":function(){return c()(".two-up.view .wrap",this.file).each((e=this,function(t,i){return c()("img",i).each(function(){if(c()(this).width()>v/2)return c()(this).width(v/2)}),e.requestImageInfo(c()("img",i),function(e,t){return c()(".image-info .meta-width",i).text(e+"px"),c()(".image-info .meta-height",i).text(t+"px"),c()(".image-info",i).removeClass("hide")})}));var e},swipe:function(){var e,t,i;return t=0,e=0,c()(".swipe.view",this.file).each((i=this,function(n,r){var a,o,s,u,d,l;l=i.prepareFrames(r),a=f(l,2),t=a[0],e=a[1],u=c()(".swipe-frame",r),o=c()(".swipe-wrap",r),s=c()(".swipe-bar",r),u.css({width:t+16,height:e+28}),o.css({width:t+1,height:e+2}),s.css({left:1}),d=parseInt(o.css("right").replace("px",""),10),i.initDraggable(s,d,function(e,i){i>0&&i<u.width()-2*d&&(o.width(t+1-i),s.css("left",i))})}))},"onion-skin":function(){var e,t,i,n;return i=0,t=0,e=c()(".drag-track",this.file).width()-c()(".dragger",this.file).width(),c()(".onion-skin.view",this.file).each((n=this,function(r,a){var o,s,u,d,l,h,g;g=n.prepareFrames(a),o=f(g,2),i=o[0],t=o[1],s=c()(".onion-skin-frame",a),l=c()(".frame.added",a),u=c()(".drag-track",a),d=c()(".dragger",u),s.css({width:i+16,height:t+28}),c()(".swipe-wrap",a).css({width:i+1,height:t+2}),d.css({left:e}),l.css("opacity",1),h=parseInt(l.css("right").replace("px",""),10),n.initDraggable(d,h,function(t,i){var n=i/e;n>=0&&n<=1&&(d.css("left",i),l.css("opacity",n))})}))}},this.file=t,this.requestImageInfo(c()(".two-up.view .frame.deleted img",this.file),(i=this,function(e,t){return i.requestImageInfo(c()(".two-up.view .frame.added img",i.file),function(e,t){i.initViewModes(),c()(".two-up.view img",i.file).waitForImages(function(){i.initView("two-up")})})}))}return p(e,[{key:"initViewModes",value:function(){var e,t=w[0];return c()(".view-modes",this.file).removeClass("hide"),c()(".view-modes-menu",this.file).on("click","li",(e=this,function(t){if(!c()(t.currentTarget).hasClass("active"))return e.activateViewMode(t.currentTarget.className)})),this.activateViewMode(t)}},{key:"activateViewMode",value:function(e){return c()(".view-modes-menu li",this.file).removeClass("active").filter("."+e).addClass("active"),c()(".view:visible:not(."+e+")",this.file).fadeOut(200,(t=this,function(){return c()(".view."+e,t.file).fadeIn(200),t.initView(e)}));var t}},{key:"initView",value:function(e){return this.views[e].call(this)}},{key:"initDraggable",value:function(e,t,i){var n=!1,r=c()("body"),a=e.parent();e.off("mousedown").on("mousedown",function(){n=!0,r.css("user-select","none")}),r.off("mouseup").off("mousemove").on("mouseup",function(){n=!1,r.css("user-select","")}).on("mousemove",function(e){var r;n&&(r=e.pageX-(a.offset().left+t),i(e,r))})}},{key:"prepareFrames",value:function(e){var t,i;return i=0,t=0,c()(".frame",e).each(function(e,n){var r,a;return a=c()(n).width(),r=c()(n).height(),i=a>i?a:i,t=r>t?r:t}).css({width:i,height:t}),[i,t]}},{key:"requestImageInfo",value:function(e,t){var i,n=e.get(0);if(n)return n.complete?t.call(this,n.naturalWidth,n.naturalHeight):e.on("load",(i=this,function(){return t.call(i,n.naturalWidth,n.naturalHeight)}))}}]),e}();var b=t.a={addCommentIndicator:r,removeCommentIndicator:function(e){var t=e.querySelector(".comment-indicator"),i=e.querySelector("img"),n=!!t,r={};return n&&(r={x:parseInt(t.style.left,10),y:parseInt(t.style.top,10),image:{width:i.width,height:i.height}},t.remove()),Object.assign({},r,{removed:n})},showCommentIndicator:function(e,t){var i=t.x,n=t.y,a=e.querySelector(".comment-indicator");a?(a.style.left=i+"px",a.style.top=n+"px"):r(e,t)},commentIndicatorOnClick:function(e){e.stopPropagation(),e.currentTarget.closest(".diff-viewer").querySelector(".note-container .note-textarea").focus()},addImageBadge:function(e,t){var i=t.coordinate,r=t.badgeText,a=n(t.noteId,i,["badge"]);a.innerText=r,e.appendChild(a)},addImageCommentBadge:function(e,t){var i=t.coordinate,r=n(t.noteId,i,["image-comment-badge"]);r.innerHTML=gl.utils.spriteIcon("image-comment-dark"),e.appendChild(r)},addAvatarBadge:function(e,t){var i=t.detail,n=i.noteId,r=i.badgeNumber,a=e.querySelector("#"+n+" .badge");a.innerText=r,a.classList.remove("hidden")},setPositionDataAttribute:function(e,t){var i=t.x,n=t.y,r=t.width,a=t.height,o=e.dataset.position,s=Object.assign({},JSON.parse(o),{x:i,y:n,width:r,height:a});e.setAttribute("data-position",JSON.stringify(s))},updateDiscussionAvatarBadgeNumber:function(e,t){e.querySelector(".image-diff-avatar-link .badge").innerText=t},updateDiscussionBadgeNumber:function(e,t){e.querySelector(".badge").innerText=t},toggleCollapsed:function(e){var t=e.currentTarget.closest(".discussion-notes"),i=t.querySelector(".discussion-form"),n=t.classList.contains("collapsed");n?t.classList.remove("collapsed"):t.classList.add("collapsed"),i&&!n?i.style.display="none":i&&n&&(i.style.display="block")},resizeCoordinatesToImageElement:function(e,t){var i=t.x,n=t.y,r=t.width,a=t.height,o=e.width,s=e.height,c=o/r,u=s/a;return{x:Math.round(i*c),y:Math.round(n*u),width:o,height:s}},generateBadgeFromDiscussionDOM:function(e,t){var i=JSON.parse(t.dataset.position),n=t.querySelector(".note");return new o({actual:i,imageEl:e.querySelector("img"),noteId:n.id,discussionId:t.dataset.discussionId})},getTargetSelection:function(e){var t=e.currentTarget.querySelector("img"),i=e.offsetX,n=e.offsetY,r=t.width,a=t.height,o=t.naturalWidth,s=t.naturalHeight,c=o/r,u=s/a,d=Math.max(0,i)&&Math.min(i,r),l=Math.max(0,n)&&Math.min(n,a);return{browser:{x:d,y:l,width:r,height:a},actual:{x:Math.round(d*c),y:Math.round(l*u),width:o,height:s}}},initImageDiff:function(e,t,i){var n={canCreateNote:t,renderCommentBadge:i},r=void 0;return new y(e),e.querySelector(".diff-file .js-single-image")?(r=new d(e,n)).init():e.querySelector(".diff-file .js-replaced-image")&&(r=new m(e,n)).init(),r}}}}]);
//# sourceMappingURL=commons~pages.projects.compare.show~pages.snippets.show.c438c0a2.chunk.js.map